<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EEG 实验控制页面</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 0; padding: 20px; background: #f0f2f5; 
    }
    h1 { text-align: center; color: #333; margin-bottom: 20px; }
    .controls, .parameters {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .controls button, .controls select { 
      font-size: 0.9em; 
    }
    .controls button {
      margin-right: 8px;
      padding: 6px 12px;
    }
    .parameters .param {
      margin-bottom: 10px;
      font-size: 0.85em;
    }
    .parameters label { display: inline-block; width: 110px; }
    .parameters input[type=range],
    .parameters input[type=number],
    .parameters select {
      width: 140px;
      vertical-align: middle;
    }
    .parameters span {
      display: inline-block; width: 40px; text-align: right;
    }
    #restCountdown {
      font-size: 1.2em; color: orange; margin-bottom: 10px;
    }
    #stimulusCanvas {
      background: #222;
      display: block;
      margin: 0 auto 10px;
      border-radius: 8px;
    }
    #description { margin-top: 8px; font-size: 0.95em; color: #555; }
    .info { margin-top: 8px; font-size: 0.9em; color: #444; }
  </style>
</head>
<body>
  <h1>EEG 实验控制平台</h1>

  <div class="controls">
    <label for="expSelect">实验范式:</label>
    <select id="expSelect">
      <option value="pushPullPerception">推拉知觉范式</option>
      <option value="steadyStateContrast">稳态对比度响应范式</option>
      <option value="monocularLearning">单眼知觉学习范式</option>
      <option value="binocularInteraction">双眼交互范式</option>
      <option value="centralPeripheralSSVEP">中央与周边SSVEP范式</option>
      <option value="nonlinearVision">非线性视觉恢复范式</option>
    </select>
    <div id="description"></div>
    <div style="margin-top:10px;">
      <button id="startBtn">开始</button>
      <button id="stopBtn" disabled>停止</button>
      <button id="resetBtn">重置</button>
      <button id="reportBtn" disabled>查看报告</button>
    </div>
    <div id="restCountdown" style="display:none;">休息中: <span id="restValCountdown"></span>s</div>
  </div>

  <div class="parameters">
    <div class="param">
      <label>频率1 (Hz):</label>
      <input type="range" id="frequency1" min="4" max="20" step="0.5" value="8">
      <span id="freq1Val"></span>
    </div>
    <div class="param">
      <label>频率2 (Hz):</label>
      <input type="range" id="frequency2" min="4" max="20" step="0.5" value="12">
      <span id="freq2Val"></span>
    </div>
    <div class="param">
      <label>对比度:</label>
      <input type="range" id="contrast" min="0.1" max="1" step="0.05" value="0.5">
      <span id="contrastVal"></span>
    </div>
    <div class="param">
      <label>时长 (s):</label>
      <input type="range" id="duration" min="5" max="120" step="5" value="20">
      <span id="durationVal"></span>
    </div>
    <div class="param">
      <label>刺激大小 (px):</label>
      <input type="range" id="stimulusSize" min="100" max="600" step="10" value="200">
      <span id="stimulusSizeVal"></span>
    </div>
    <div class="param">
      <label>重复次数:</label>
      <input type="number" id="repetitions" min="1" max="10" value="1">
    </div>
    <div class="param">
      <label>休息间隔 (s):</label>
      <input type="range" id="restInterval" min="1" max="20" step="1" value="5">
      <span id="restVal"></span>
    </div>
    <div class="param">
      <label>空间频率:</label>
      <input type="range" id="spatialFreq" min="1" max="20" step="0.5" value="10">
      <span id="spatialVal"></span>
    </div>
    <div class="param">
      <label>视距 (cm):</label>
      <input type="range" id="viewingDistance" min="30" max="100" step="1" value="57">
      <span id="viewVal"></span>
    </div>
    <div class="param">
      <label>左眼为优势:</label>
      <input type="checkbox" id="eyeDominance" checked>
    </div>
    <div class="param">
      <label>启用运动:</label>
      <input type="checkbox" id="motionEnabled">
    </div>
    <div class="param">
      <label>运动方向:</label>
      <label><input type="radio" name="motionDir" value="horizontal" checked> 水平</label>
      <label><input type="radio" name="motionDir" value="vertical"> 垂直</label>
    </div>
    <div class="param">
      <label>运动速度:</label>
      <input type="range" id="motionSpeed" min="0" max="5" step="0.1" value="1">
      <span id="motionVal"></span>
    </div>
  </div>

  <canvas id="stimulusCanvas" width="200" height="100"></canvas>
  <div class="info" id="info"></div>

  <script>
    // 描述字典
    const experimentDescriptions = {
      pushPullPerception: "推拉知觉范式: 同时刺激两只眼睛，加强弱视眼信号，同时抑制健康眼信号。",
      steadyStateContrast: "稳态对比度响应范式: 呈现不同对比度水平的视觉刺激，记录脑电反应。",
      monocularLearning: "单眼知觉学习范式: 使用重复的定向辨别或对比度检测任务，专门训练弱视眼。",
      binocularInteraction: "双眼交互范式: 使用fMRI和特定刺激条件评估视觉皮层中的兴奋性和抑制性贡献。",
      centralPeripheralSSVEP: "中央与周边SSVEP范式: 在视野的不同区域呈现视觉刺激，评估不同区域的视觉处理。",
      nonlinearVision: "非线性视觉恢复范式: 使用特定的刺激序列和分析方法评估视觉系统的非线性特性。"
    };

    // 全局参数
    let params = {
      frequency1: 8.0,
      frequency2: 12.0,
      contrast: 0.5,
      duration: 20.0,
      stimulusSize: 200,
      repetitions: 1,
      restInterval: 5.0,
      spatialFreq: 10.0,
      viewingDistance: 57.0,
      eyeDominance: true,
      motionEnabled: false,
      motionDirection: 'horizontal',
      motionSpeed: 1.0
    };
    let isRunning = false;
    let currentRep = 0;
    let startTime = 0;
    let restTimer = null;
    let trialTimer = null;

    // 元素
    const canvas = document.getElementById('stimulusCanvas');
    const ctx    = canvas.getContext('2d');
    const expSelect  = document.getElementById('expSelect');
    const descEl     = document.getElementById('description');
    const infoEl     = document.getElementById('info');
    const restEl     = document.getElementById('restCountdown');
    const restValCD  = document.getElementById('restValCountdown');
    const startBtn   = document.getElementById('startBtn');
    const stopBtn    = document.getElementById('stopBtn');
    const resetBtn   = document.getElementById('resetBtn');
    const reportBtn  = document.getElementById('reportBtn');

    // 绑定输入工具
    function bindParam(id, key, dispId, transform=v=>v) {
      const el = document.getElementById(id);
      const disp = dispId && document.getElementById(dispId);
      function update() {
        params[key] = transform(el.type==='checkbox'?el.checked: parseFloat(el.value));
        if (disp) disp.textContent = el.type==='checkbox'?el.checked:el.value;
        if (id==='stimulusSize') resizeCanvas();
      }
      el.addEventListener('input', update);
      update();
    }
    bindParam('frequency1','frequency1','freq1Val');
    bindParam('frequency2','frequency2','freq2Val');
    bindParam('contrast','contrast','contrastVal');
    bindParam('duration','duration','durationVal');
    bindParam('stimulusSize','stimulusSize','stimulusSizeVal', v=>parseInt(v));
    bindParam('repetitions','repetitions',null, v=>parseInt(v,10));
    bindParam('restInterval','restInterval','restVal');
    bindParam('spatialFreq','spatialFreq','spatialVal');
    bindParam('viewingDistance','viewingDistance','viewVal');
    bindParam('eyeDominance','eyeDominance',null, v=>v);
    bindParam('motionEnabled','motionEnabled',null, v=>v);
    document.querySelectorAll("input[name='motionDir']")
      .forEach(r => r.addEventListener('change', e => params.motionDirection = e.target.value));
    );
    bindParam('motionSpeed','motionSpeed','motionVal');

    // 选择实验时更新描述 & 重置
    expSelect.addEventListener('change', ()=> {
      descEl.textContent = experimentDescriptions[expSelect.value];
      if (expSelect.value==='centralPeripheralSSVEP') {
        descEl.textContent += ` 请与屏幕保持约 ${Math.round(params.viewingDistance)} cm 距离，以获得 8° 中央视野。`;
      }
      resetExperiment();
    });
    descEl.textContent = experimentDescriptions[expSelect.value];

    // 调整画布尺寸
    function resizeCanvas() {
      canvas.width  = params.stimulusSize;
      canvas.height = params.stimulusSize * 0.5;
    }
    resizeCanvas();

    // 渲染一个周期
    function render() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if (!isRunning) return;
      const t = (Date.now()-startTime)/1000;
      const off = (t * params.motionSpeed) % 1;
      const dir = params.motionDirection;
      const freq1 = params.frequency1, freq2 = params.frequency2;
      const ctr = params.contrast;
      switch(expSelect.value) {
        case 'pushPullPerception':
          drawGrating(0,0,canvas.width/2,canvas.height,freq1,ctr,true,dir,off);
          drawGrating(canvas.width/2,0,canvas.width/2,canvas.height,freq2,ctr,false,dir,off);
          break;
        case 'steadyStateContrast':
          drawGrating(0,0,canvas.width,canvas.height,freq1,ctr,true,dir,off);
          drawCircle(canvas.width/2,canvas.height/2,20);
          break;
        case 'monocularLearning':
          drawGrating(0,0,canvas.width,canvas.height,freq1,ctr,true,dir,off);
          ctx.fillStyle='white';
          ctx.font='20px sans-serif';
          ctx.fillText(params.eyeDominance?'左眼训练':'右眼训练',10,30);
          break;
        case 'binocularInteraction':
          drawGrating(0,0,canvas.width/2,canvas.height,freq1,ctr,true,dir,off);
          drawGrating(canvas.width/2,0,canvas.width/2,canvas.height,freq2,ctr,false,dir,off);
          drawCircle(canvas.width/2,canvas.height/2,8);
          break;
        case 'centralPeripheralSSVEP':
          drawFlickerCircle(canvas.width/2,canvas.height/2,canvas.height*0.4,freq2,ctr,off);
          drawFlickerCircle(canvas.width/2,canvas.height/2,canvas.height*0.2,freq1,ctr,off);
          break;
        case 'nonlinearVision':
          for(let i=0;i<4;i++){
            drawGrating(0,0,canvas.width,canvas.height,
              params.frequency1+i, ctr/(i+1), i%2===0, dir, off + i*0.25);
          }
          break;
      }
    }

    // 绘图函数
    function drawGrating(x,y,w,h,freq,contrast,vertical,dir,off) {
      const img = ctx.createImageData(w,h);
      for(let i=0;i<w;i++) for(let j=0;j<h;j++){
        const p = vertical?(i/w):(j/h);
        let pos = (p + off) % 1;
        const v = Math.sin(2*Math.PI*freq*pos);
        const intensity = (v*contrast*0.5+0.5)*255;
        const idx = (j*w+i)*4;
        img.data[idx]=img.data[idx+1]=img.data[idx+2]=intensity;
        img.data[idx+3]=255;
      }
      ctx.putImageData(img,x,y);
    }
    function drawCircle(cx,cy,r){
      ctx.strokeStyle='red';
      ctx.beginPath();
      ctx.arc(cx,cy,r,0,2*Math.PI);
      ctx.stroke();
    }
    function drawFlickerCircle(cx,cy,r,freq,contrast,off){
      const t = (Date.now()-startTime)/1000;
      const alpha = (Math.sin(2*Math.PI*freq*t+off*2*Math.PI)*0.5+0.5)*contrast;
      ctx.beginPath();
      ctx.arc(cx,cy,r,0,2*Math.PI);
      ctx.fillStyle=`rgba(255,255,255,${alpha})`;
      ctx.fill();
    }

    // 实验序列控制
    function startExperiment(){
      if (isRunning) return;
      isRunning = true;
      startBtn.disabled = true;
      stopBtn.disabled  = false;
      reportBtn.disabled = true;
      currentRep = 1;
      runTrial();
    }
    function runTrial(){
      startTime = Date.now();
      render();
      trialTimer = setInterval(()=>{
        render();
        const elapsed = (Date.now()-startTime)/1000;
        infoEl.textContent = `第 ${currentRep}/${params.repetitions} 次  时间: ${Math.floor(elapsed)}/${params.duration}s`;
        if (elapsed >= params.duration) {
          clearInterval(trialTimer);
          if (currentRep < params.repetitions) {
            startRest();
          } else {
            endExperiment();
          }
        }
      }, 1000/30);
    }
    function startRest(){
      isRunning = false;
      let sec = params.restInterval;
      restEl.style.display = 'block';
      restValCD.textContent = sec;
      restTimer = setInterval(()=>{
        sec--;
        restValCD.textContent = sec;
        if (sec<=0){
          clearInterval(restTimer);
          restEl.style.display = 'none';
          currentRep++;
          isRunning = true;
          runTrial();
        }
      }, 1000);
    }
    function stopExperiment(){
      clearInterval(trialTimer);
      clearInterval(restTimer);
      isRunning = false;
      startBtn.disabled = false;
      stopBtn.disabled  = true;
    }
    function resetExperiment(){
      stopExperiment();
      infoEl.textContent = '';
      restEl.style.display = 'none';
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }
    function endExperiment(){
      stopExperiment();
      reportBtn.disabled = false;
      infoEl.textContent = '实验完成，点击“查看报告”。';
    }

    // 查看报告（示例计算 SNR）
    reportBtn.addEventListener('click', ()=>{
      // 这里可以实现真实 SNR 计算
      alert('SNR报告（示例）：\n频率1 SNR=12.3 dB\n频率2 SNR=10.8 dB');
    });

    // 按钮绑定
    startBtn.addEventListener('click', startExperiment);
    stopBtn.addEventListener('click', stopExperiment);
    resetBtn.addEventListener('click', resetExperiment);
  </script>
</body>
</html>
