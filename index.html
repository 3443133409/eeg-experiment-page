<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EEG å®éªŒæ§åˆ¶é¡µé¢</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f0f2f5; }
    h1 { text-align: center; color: #333; margin-bottom: 20px; }
    .controls, .parameters { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .controls button { margin-right: 10px; padding: 8px 16px; font-size: 1em; }
    .parameters label { display: inline-block; width: 120px; }
    .parameters .param { margin-bottom: 10px; }
    #stimulusCanvas { background: #222; display: block; margin: 0 auto; border-radius: 8px; }
    #description { margin-top: 10px; font-size: 0.95em; color: #555; }
    .info { margin-top: 10px; font-size: 0.9em; color: #444; }
  </style>
</head>
<body>
  <h1>ğŸ§   EEGå®éªŒæ§åˆ¶å¹³å°</h1>

  <div class="controls">
    <label for="expSelect">å®éªŒèŒƒå¼ï¼š</label>
    <select id="expSelect">
      <option value="pushPullPerception">æ¨æ‹‰çŸ¥è§‰èŒƒå¼</option>
      <option value="steadyStateContrast">ç¨³æ€å¯¹æ¯”åº¦å“åº”èŒƒå¼</option>
      <option value="monocularLearning">å•çœ¼çŸ¥è§‰å­¦ä¹ èŒƒå¼</option>
      <option value="binocularInteraction">åŒçœ¼äº¤äº’èŒƒå¼</option>
      <option value="centralPeripheralSSVEP">ä¸­å¤®ä¸å‘¨è¾¹SSVEPèŒƒå¼</option>
      <option value="nonlinearVision">éçº¿æ€§è§†è§‰æ¢å¤èŒƒå¼</option>
    </select>
    <div id="description"></div>
    <div style="margin-top:10px;">
      <button id="startBtn">å¼€å§‹</button>
      <button id="stopBtn" disabled>åœæ­¢</button>
      <button id="resetBtn">é‡ç½®</button>
    </div>
  </div>

  <div class="parameters">
    <div class="param"><label>é¢‘ç‡1 (Hz):</label><input type="range" id="frequency1" min="4" max="20" step="0.5"><span id="freq1Val"></span></div>
    <div class="param"><label>é¢‘ç‡2 (Hz):</label><input type="range" id="frequency2" min="4" max="20" step="0.5"><span id="freq2Val"></span></div>
    <div class="param"><label>å¯¹æ¯”åº¦:</label><input type="range" id="contrast" min="0.1" max="1" step="0.05"><span id="contrastVal"></span></div>
    <div class="param"><label>æ—¶é•¿ (s):</label><input type="range" id="duration" min="5" max="120" step="5"><span id="durationVal"></span></div>
    <div class="param"><label>é‡å¤æ¬¡æ•°:</label><input type="number" id="repetitions" min="1" max="10"><span></span></div>
    <div class="param"><label>ä¼‘æ¯é—´éš” (s):</label><input type="range" id="restInterval" min="1" max="20" step="1"><span id="restVal"></span></div>
    <div class="param"><label>ç©ºé—´é¢‘ç‡:</label><input type="range" id="spatialFreq" min="1" max="20" step="0.5"><span id="spatialVal"></span></div>
    <div class="param"><label>è§†è· (cm):</label><input type="range" id="viewingDistance" min="30" max="100" step="1"><span id="viewVal"></span></div>
    <div class="param"><label>å·¦çœ¼ä¼˜åŠ¿:</label><input type="checkbox" id="eyeDominance"></div>
    <div class="param"><label>å¯ç”¨è¿åŠ¨:</label><input type="checkbox" id="motionEnabled"></div>
    <div class="param"><label>è¿åŠ¨æ–¹å‘:</label>
      <label><input type="radio" name="motionDir" value="horizontal" checked> æ°´å¹³</label>
      <label><input type="radio" name="motionDir" value="vertical"> å‚ç›´</label>
    </div>
    <div class="param"><label>è¿åŠ¨é€Ÿåº¦:</label><input type="range" id="motionSpeed" min="0" max="5" step="0.1"><span id="motionVal"></span></div>
  </div>

  <canvas id="stimulusCanvas" width="600" height="300"></canvas>
  <div class="info" id="info"></div>

  <script>
    // å‚æ•°ä¸æè¿°å­—å…¸
    const experimentDescriptions = {
      pushPullPerception: "æ¨æ‹‰çŸ¥è§‰èŒƒå¼: åŒæ—¶åˆºæ¿€ä¸¤åªçœ¼ç›ï¼ŒåŠ å¼ºå¼±è§†çœ¼ä¿¡å·ï¼ŒåŒæ—¶æŠ‘åˆ¶å¥åº·çœ¼ä¿¡å·ã€‚",
      steadyStateContrast: "ç¨³æ€å¯¹æ¯”åº¦å“åº”èŒƒå¼: å‘ˆç°ä¸åŒå¯¹æ¯”åº¦æ°´å¹³çš„è§†è§‰åˆºæ¿€ï¼Œè®°å½•è„‘ç”µååº”ã€‚",
      monocularLearning: "å•çœ¼çŸ¥è§‰å­¦ä¹ èŒƒå¼: ä½¿ç”¨é‡å¤çš„å®šå‘è¾¨åˆ«æˆ–å¯¹æ¯”åº¦æ£€æµ‹ä»»åŠ¡ï¼Œä¸“é—¨è®­ç»ƒå¼±è§†çœ¼ã€‚",
      binocularInteraction: "åŒçœ¼äº¤äº’èŒƒå¼: ä½¿ç”¨fMRIå’Œç‰¹å®šåˆºæ¿€æ¡ä»¶è¯„ä¼°è§†è§‰çš®å±‚ä¸­çš„å…´å¥‹æ€§å’ŒæŠ‘åˆ¶æ€§è´¡çŒ®ã€‚",
      centralPeripheralSSVEP: "ä¸­å¤®ä¸å‘¨è¾¹SSVEPèŒƒå¼: åœ¨è§†é‡çš„ä¸åŒåŒºåŸŸå‘ˆç°è§†è§‰åˆºæ¿€ï¼Œè¯„ä¼°ä¸åŒåŒºåŸŸçš„è§†è§‰å¤„ç†ã€‚",
      nonlinearVision: "éçº¿æ€§è§†è§‰æ¢å¤èŒƒå¼: ä½¿ç”¨ç‰¹å®šçš„åˆºæ¿€åºåˆ—å’Œåˆ†ææ–¹æ³•è¯„ä¼°è§†è§‰ç³»ç»Ÿçš„éçº¿æ€§ç‰¹æ€§ã€‚"
    };

    // å…¨å±€å‚æ•°å¯¹è±¡
    let params = {
      frequency1: 8.0,
      frequency2: 12.0,
      contrast: 0.5,
      duration: 20,
      repetitions: 1,
      restInterval: 5,
      spatialFreq: 10,
      viewingDistance: 57,
      eyeDominance: true,
      motionEnabled: false,
      motionDirection: 'horizontal',
      motionSpeed: 1.0
    };
    let isRunning = false;
    let startTime = 0;
    const canvas = document.getElementById('stimulusCanvas');
    const ctx = canvas.getContext('2d');

    // UI å…ƒç´ 
    const expSelect = document.getElementById('expSelect');
    const descEl = document.getElementById('description');
    const infoEl = document.getElementById('info');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resetBtn = document.getElementById('resetBtn');

    // ç»‘å®šå‚æ•°è¾“å…¥
    function bindParam(id, key, displayId, transform=(v=>v)) {
      const el = document.getElementById(id);
      const disp = document.getElementById(displayId);
      function update() {
        params[key] = transform(el.type==='checkbox' ? el.checked : parseFloat(el.value));
        if (disp) disp.textContent = el.type === 'checkbox' ? el.checked : el.value + (displayId === 'contrastVal' ? '' : '');
        
        // é€šçŸ¥ Swift ç«¯å‚æ•°å˜åŒ–
        window.webkit.messageHandlers.parameterChange.postMessage({
          parameter: key,
          value: params[key]
        });
      }
      el.addEventListener('input', update);
      update();
    }
    bindParam('frequency1','frequency1','freq1Val');
    bindParam('frequency2','frequency2','freq2Val');
    bindParam('contrast','contrast','contrastVal',v=>v);
    bindParam('duration','duration','durationVal');
    bindParam('repetitions','repetitions',null); document.getElementById('repetitions').addEventListener('change', e=>params.repetitions=parseInt(e.target.value));
    bindParam('restInterval','restInterval','restVal');
    bindParam('spatialFreq','spatialFreq','spatialVal');
    bindParam('viewingDistance','viewingDistance','viewVal');
    bindParam('eyeDominance','eyeDominance',null);
    bindParam('motionEnabled','motionEnabled',null);
    document.getElementsByName('motionDir').forEach(radio=>radio.addEventListener('change', e=>params.motionDirection=e.target.value));
    bindParam('motionSpeed','motionSpeed','motionVal');

    expSelect.addEventListener('change', ()=>{
      descEl.textContent = experimentDescriptions[expSelect.value];
    });
    descEl.textContent = experimentDescriptions[expSelect.value];

    // æ¸²æŸ“å¾ªç¯
    function render() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(!isRunning) { requestAnimationFrame(render); return; }
      const t = (Date.now()-startTime)/1000;
      const freq1 = params.frequency1, freq2 = params.frequency2;
      const contrast = params.contrast;
      const dir = params.motionDirection;
      const speed = params.motionSpeed;
      const offset = (t*speed)%1;
      switch(expSelect.value) {
        case 'pushPullPerception':
          drawGrating(0,0,canvas.width/2,canvas.height,freq1,contrast,true,dir,offset);
          drawGrating(canvas.width/2,0,canvas.width/2,canvas.height,freq2,contrast,false,dir,offset);
          break;
        case 'steadyStateContrast':
          drawGrating(0,0,canvas.width,canvas.height,freq1,contrast,true,dir,offset);
          drawCircle(canvas.width/2,canvas.height/2,20);
          break;
        case 'monocularLearning':
          drawGrating(0,0,canvas.width,canvas.height,freq1,contrast,true,dir,offset);
          ctx.fillStyle='white'; ctx.font='20px sans-serif'; ctx.fillText(params.eyeDominance?'å·¦çœ¼è®­ç»ƒ':'å³çœ¼è®­ç»ƒ',10,30);
          break;
        case 'binocularInteraction':
          drawGrating(0,0,canvas.width/2,canvas.height,freq1,contrast,true,dir,offset);
          drawGrating(canvas.width/2,0,canvas.width/2,canvas.height,freq2,contrast,false,dir,offset);
          break;
        case 'centralPeripheralSSVEP':
          drawFlickerCircle(canvas.width/2,canvas.height/2,canvas.height*0.4,freq2,contrast);
          drawFlickerCircle(canvas.width/2,canvas.height/2,canvas.height*0.2,freq1,contrast);
          break;
        case 'nonlinearVision':
          for(let i=0;i<4;i++){
            drawGrating(0,0,canvas.width,canvas.height,
              params.frequency1+i, contrast/(i+1), i%2===0, dir, offset + i*0.25);
          }
          break;
      }
      // ä¿¡æ¯å±•ç¤º
      const elapsed = Math.floor(t);
      infoEl.textContent = `æ—¶é—´: ${elapsed}s / ${params.duration}s`;
      if(elapsed>=params.duration) stopExperiment();
      else requestAnimationFrame(render);
    }

    function drawGrating(x,y,w,h,freq,contrast,vertical,dir,off) {
      const imgData = ctx.createImageData(w,h);
      for(let i=0;i<w;i++) for(let j=0;j<h;j++){
        const p = vertical? (i/w): (j/h);
        const pos = (p + off)%(1.0);
        const v = Math.sin(2*Math.PI*freq*pos);
        const intensity = (v*contrast*0.5+0.5)*255;
        const idx = (j*w+i)*4;
        imgData.data[idx]=imgData.data[idx+1]=imgData.data[idx+2]=intensity;
        imgData.data[idx+3]=255;
      }
      ctx.putImageData(imgData,x,y);
    }
    function drawCircle(cx,cy,r){ ctx.strokeStyle='red'; ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.stroke(); }
    function drawFlickerCircle(cx,cy,r,freq,contrast){ const t=(Date.now()-startTime)/1000; const alpha=(Math.sin(2*Math.PI*freq*t)*0.5+0.5)*contrast; ctx.fillStyle=`rgba(255,255,255,${alpha})`; ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.fill(); }

    // æ§åˆ¶å‡½æ•°
    function startExperiment(){ if(isRunning) return; isRunning=true; startTime=Date.now(); stopBtn.disabled=false; startBtn.disabled=true; render(); }
    function stopExperiment(){ isRunning=false; stopBtn.disabled=true; startBtn.disabled=false; }
    function resetExperiment(){ stopExperiment(); ctx.clearRect(0,0,canvas.width,canvas.height); infoEl.textContent=''; }

    startBtn.addEventListener('click', startExperiment);
    stopBtn.addEventListener('click', stopExperiment);
    resetBtn.addEventListener('click', resetExperiment);
  </script>
</body>
</html>

